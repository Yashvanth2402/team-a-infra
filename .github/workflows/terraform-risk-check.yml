name: Terraform AI Risk Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "environments/**.tf"
      - "environments/**.tfvars"

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  terraform-risk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # REQUIRED to detect changed files

      - name: Detect environment from changed files
        id: detect-env
        run: |
          echo "Detecting environment from PR changes..."

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          ENVIRONMENTS=$(echo "$CHANGED_FILES" \
            | grep '^environments/' \
            | awk -F'/' '{print $2}' \
            | sort -u)

          ENV_COUNT=$(echo "$ENVIRONMENTS" | wc -l)

          if [ "$ENV_COUNT" -eq 0 ]; then
            echo "âŒ No environment changes detected"
            exit 1
          fi

          if [ "$ENV_COUNT" -gt 1 ]; then
            echo "âŒ Multiple environments modified:"
            echo "$ENVIRONMENTS"
            echo "ðŸš¨ One PR must target only ONE environment"
            exit 1
          fi

          ENV=$(echo "$ENVIRONMENTS")
          echo "âœ… Detected environment: $ENV"

          echo "env=$ENV" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init -input=false
        working-directory: environments/${{ steps.detect-env.outputs.env }}

      - name: Terraform Plan
        run: |
          terraform plan -out=tfplan -input=false
          terraform show -json tfplan > plan.json
        working-directory: environments/${{ steps.detect-env.outputs.env }}

      - name: Generate plan checksum
        run: |
          sha256sum plan.json | awk '{print $1}' > checksum.txt
        working-directory: environments/${{ steps.detect-env.outputs.env }}

      - name: Build AI payload
        run: |
          jq -n \
            --arg pr "${{ github.event.pull_request.number }}" \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.head_ref }}" \
            --arg sha "${{ github.sha }}" \
            --arg actor "${{ github.actor }}" \
            --arg env "${{ steps.detect-env.outputs.env }}" \
            --arg cloud "azure" \
            --slurpfile plan plan.json \
            --rawfile checksum checksum.txt \
            '{
              metadata: {
                pr_id: $pr,
                repo: $repo,
                branch: $branch,
                commit_sha: $sha,
                ci_system: "github-actions",
                triggered_by: $actor
              },
              environment: {
                name: $env,
                cloud: $cloud
              },
              terraform_plan: $plan[0],
              checksum: $checksum
            }' > payload.json
        working-directory: environments/${{ steps.detect-env.outputs.env }}

      - name: Call AI Risk Engine
        run: |
          AI_ENDPOINT_CLEAN="$(echo -n "${{ secrets.AI_RISK_ENDPOINT }}")"

          curl -s -X POST "$AI_ENDPOINT_CLEAN" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.AI_RISK_API_KEY }}" \
            -d @payload.json \
            > ai_response.json

          echo "AI response:"
          cat ai_response.json
        working-directory: environments/${{ steps.detect-env.outputs.env }}

      - name: Build PR comment
        run: |
          RISK_LEVEL=$(jq -r '.risk_level' ai_response.json)
          DECISION=$(jq -r '.decision' ai_response.json)
          CONFIDENCE=$(jq -r '.confidence // "N/A"' ai_response.json)
          EXPLANATION=$(jq -r '.explanation' ai_response.json)

          cat <<EOF > pr_comment.md
## ðŸ¤– Autonomous Cloud Change Risk Investigator

**Environment:** ${{ steps.detect-env.outputs.env }}  
**Risk Level:** $RISK_LEVEL  
**Decision:** $DECISION  
**Confidence:** $CONFIDENCE  

### ðŸ§  AI Explanation
$EXPLANATION

---
*Generated automatically by the AI Risk Platform*
EOF
        working-directory: environments/${{ steps.detect-env.outputs.env }}

      - name: Post AI comment on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -f body="$(cat environments/${{ steps.detect-env.outputs.env }}/pr_comment.md)"
