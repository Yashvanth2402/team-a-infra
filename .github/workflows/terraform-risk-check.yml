name: Terraform AI Risk Check

on:
  pull_request:
    branches: [ main, dev1 ]
    paths:
      - "modules/**"
      - "environments/**"
      - "globals/**"
      - "bootstrap/**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform-risk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        working-directory: environments/dev
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: environments/dev
        run: |
          terraform plan -out=tfplan
          terraform show -json tfplan > plan.json

      - name: Build AI Payload
        working-directory: environments/dev
        run: |
          jq -n \
            --arg env "dev" \
            --arg cloud "azure" \
            --slurpfile plan plan.json \
            '{
              environment: {
                name: $env,
                cloud: $cloud
              },
              terraform_plan: $plan[0]
            }' > payload.json

      - name: Call AI Platform using GitHub OIDC
        working-directory: environments/dev
        env:
          AI_ENDPOINT: ${{ secrets.AI_RISK_ENDPOINT }}
        run: |
          echo "Requesting GitHub OIDC token"

          ID_TOKEN=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" \
            | jq -r '.value')

          if [ -z "$ID_TOKEN" ] || [ "$ID_TOKEN" = "null" ]; then
            echo "Failed to get OIDC token"
            exit 1
          fi

          curl --fail -s \
            -H "Authorization: Bearer $ID_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST "$AI_ENDPOINT" \
            -d @payload.json \
            -o ai_response.json

          cat ai_response.json

      - name: Post PR Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RISK=$(jq -r '.risk_level' ai_response.json)
          DECISION=$(jq -r '.decision' ai_response.json)
          CONF=$(jq -r '.confidence' ai_response.json)
          EXPL=$(jq -r '.explanation' ai_response.json)

          cat <<EOF > comment.md
          ## ðŸ¤– Autonomous Cloud Change Risk Investigator

          **Environment:** dev  
          **Risk Level:** $RISK  
          **Decision:** $DECISION  
          **Confidence:** $CONF  

          ### ðŸ§  AI Explanation
          $EXPL

          ---
          *Generated automatically by the AI Risk Platform*
          EOF

          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -f body="$(cat comment.md)"
