name: Terraform AI Risk Check

on:
  pull_request:
    branches:
      - main
    paths:
      - "modules/**"
      - "environments/**"
      - "globals/**"
      - "bootstrap/**"

permissions:
  id-token: write
  contents: read
  pull-requests: read

jobs:
  terraform-risk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      # üîê Azure Login via OIDC (Service Principal)
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # üö® BACKEND AUTH FIX (THIS IS THE KEY)
      - name: Terraform Init
        working-directory: environments/dev
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: environments/dev
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          terraform plan -out=tfplan -input=false
          terraform show -json tfplan > plan.json
      - name: Generate checksum
        working-directory: environments/dev
        run: |
          sha256sum plan.json | awk '{print $1}' > checksum.txt
      - name: Build AI Risk Payload
        working-directory: environments/dev
        run: |
          jq -n \
            --arg pr "${{ github.event.pull_request.number }}" \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.head_ref }}" \
            --arg sha "${{ github.sha }}" \
            --arg actor "${{ github.actor }}" \
            --arg env "dev" \
            --arg cloud "azure" \
            --arg region "eastus" \
            --slurpfile plan plan.json \
            --rawfile checksum checksum.txt \
            '{
              metadata: {
                pr_id: $pr,
                repo: $repo,
                branch: $branch,
                commit_sha: $sha,
                ci_system: "github-actions",
                triggered_by: $actor
              },
              environment: {
                name: $env,
                cloud: $cloud,
                region: $region
              },
              terraform_plan: $plan[0],
              checksum: $checksum
            }' > payload.json
      # üîç DEBUG STEP (TEMP ‚Äì DO NOT SKIP)
      - name: Debug AI endpoint (TEMP ‚Äì DO NOT SKIP)
        working-directory: environments/dev
        env:
          AI_ENDPOINT: ${{ secrets.AI_RISK_ENDPOINT }}
        run: |
          echo "Length: ${#AI_ENDPOINT}"
          echo "Raw value:"
          printf '%q\n' "$AI_ENDPOINT"
      - name: Send to AI Risk Engine
        working-directory: environments/dev
        env:
          AI_ENDPOINT: ${{ secrets.AI_RISK_ENDPOINT }}
          API_KEY: ${{ secrets.AI_RISK_API_KEY }}
        run: |
          curl -s -X POST "$AI_ENDPOINT" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $API_KEY" \
            -d @payload.json
